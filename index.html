<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Report Assistant (Shared)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: { school: { blue: '#0f172a', lightBlue: '#1e3a8a', red: '#dc2626' } }
          }
        }
      }
    </script>
    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 antialiased">
    
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // --- FIREBASE CONFIGURATION (PASTE HERE) ---
        // ==========================================
        const firebaseConfig = {
            apiKey: "PASTE_YOUR_API_KEY_HERE",
            authDomain: "PASTE_YOUR_AUTH_DOMAIN_HERE",
            projectId: "PASTE_YOUR_PROJECT_ID_HERE",
            storageBucket: "PASTE_YOUR_STORAGE_BUCKET_HERE",
            messagingSenderId: "PASTE_YOUR_SENDER_ID_HERE",
            appId: "PASTE_YOUR_APP_ID_HERE"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const SHARED_DOC_ID = "global_settings"; // One shared document for everything

        // --- CONSTANTS ---
        const HPL_HIGH_ADDITIONS = ["Consistently seeks out opportunities to contribute to class discussions and collaborative work.", "Contributes thoughtfully to group work, actively listening to others.", "Plays a valuable and empathetic role in the class.", "Demonstrates confidence in their knowledge.", "Approaches lessons with confidence.", "Brings energy and enthusiasm to the classroom.", "Communicates ideas clearly and persuasively."];
        const HPL_AVERAGE_ADDITIONS = ["A willing and able collaborative learner.", "Works effectively in teams.", "Works effectively with classmates on shared tasks.", "Presents their own views clearly."];
        const HPL_LOW_ADDITIONS = ["Is developing their collaborative skills.", "Is beginning to recognise the value of collaboration.", "Would benefit from building confidence in teams.", "Is developing the confidence to share views."];

        const LANGUAGE_HIGH_ADDITIONS = [];
        const LANGUAGE_AVERAGE_ADDITIONS = [];
        const LANGUAGE_LOW_ADDITIONS = [];

        const HPL_ATTRIBUTES = { "Collaboration/Empathy": [], "Agile": [], "Hard Working": [] };

        const COMMENT_BANK = {
            "IB History": {
                "HPL": HPL_ATTRIBUTES,
                "Language": { "Excellent": LANGUAGE_HIGH_ADDITIONS, "Good": LANGUAGE_AVERAGE_ADDITIONS, "Average": LANGUAGE_AVERAGE_ADDITIONS, "Poor": LANGUAGE_LOW_ADDITIONS },
                "Assessment": { "Excellent": ["Demonstrates excellent grasp of key historical concepts."], "Good": ["Shows a good understanding of historical events."], "Average": ["Shows a basic understanding of historical events."], "Poor": ["Shows a limited understanding of key knowledge."] },
                "Homework": { "Excellent": ["Consistently completes homework to a very high standard."], "Good": ["Regularly completes homework tasks."], "Average": ["Usually completes homework tasks."], "Poor": ["Homework completion is inconsistent."] },
                "Improvement": { "Excellent": ["Continue refining essay introductions."], "Good": ["Focus on adding greater critical depth."], "Average": ["Focus on adding greater critical depth."], "Poor": ["Develop clearer arguments."] }
            },
            "IGCSE History": {
                "HPL": HPL_ATTRIBUTES,
                "Language": { "Excellent": LANGUAGE_HIGH_ADDITIONS, "Good": LANGUAGE_AVERAGE_ADDITIONS, "Average": LANGUAGE_AVERAGE_ADDITIONS, "Poor": LANGUAGE_LOW_ADDITIONS },
                "Assessment": { "Excellent": ["Demonstrates excellent grasp of key concepts."], "Good": ["Shows good understanding of events."], "Average": ["Shows satisfactory understanding of events."], "Poor": ["Limited understanding of key knowledge."] },
                "Homework": { "Excellent": ["Consistently completes homework to a high standard."], "Good": ["Regularly completes tasks."], "Average": ["Usually completes tasks."], "Poor": ["Homework completion is inconsistent."] },
                "Improvement": { "Excellent": ["Continue refining essay introductions."], "Good": ["Focus on adding depth to analysis."], "Average": ["Focus on adding depth to analysis."], "Poor": ["Develop clearer arguments."] }
            },
            "Year 9 History": {
                "Assessment": { "Excellent": ["Excellent grasp of causes."], "Good": ["Sound understanding."], "Average": ["Developing understanding."], "Poor": ["Struggles with dates."] },
                "Improvement": { "Excellent": ["Integrate historiography."], "Good": ["Focus on 'Why'."], "Average": ["Focus on 'Why'."], "Poor": ["Revise timelines."] },
                "HPL": HPL_ATTRIBUTES,
                "Homework": { "Excellent": ["Exceptional standard."], "Good": ["Completed on time."], "Average": ["Usually on time."], "Poor": ["Frequently late."] },
                "Language": { "Excellent": LANGUAGE_HIGH_ADDITIONS, "Good": LANGUAGE_AVERAGE_ADDITIONS, "Average": LANGUAGE_AVERAGE_ADDITIONS, "Poor": LANGUAGE_LOW_ADDITIONS }
            },
            "Year 9 Geography": {
                "Assessment": { "Excellent": ["Excellent analysis."], "Good": ["Good understanding."], "Average": ["Satisfactory understanding."], "Poor": ["Limited map skills."] },
                "Improvement": { "Excellent": ["Specific case studies."], "Good": ["Specific data."], "Average": ["Specific data."], "Poor": ["Grid references."] },
                "HPL": HPL_ATTRIBUTES,
                "Homework": { "Excellent": ["Exceptional standard."], "Good": ["Completed on time."], "Average": ["Usually on time."], "Poor": ["Frequently late."] },
                "Language": { "Excellent": LANGUAGE_HIGH_ADDITIONS, "Good": LANGUAGE_AVERAGE_ADDITIONS, "Average": LANGUAGE_AVERAGE_ADDITIONS, "Poor": LANGUAGE_LOW_ADDITIONS }
            }
        };

        const STANDARD_LEVELS = ["Excellent", "Good", "Average", "Poor"];
        const HPL_LEVELS = ["Collaboration/Empathy", "Agile", "Hard Working"];

        // --- ICONS ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );

        const BookOpen = ({ className }) => <Icon className={className} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />;
        const Users = ({ className }) => <Icon className={className} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />;
        const Library = ({ className }) => <Icon className={className} path={<><path d="m16 6 4 14"/><path d="M12 6v14"/><path d="M8 8v12"/><path d="M4 4v16"/></>} />;
        const Calendar = ({ className }) => <Icon className={className} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />;
        const ArrowRight = ({ className }) => <Icon className={className} path={<><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></>} />;
        const ArrowLeft = ({ className }) => <Icon className={className} path={<><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></>} />;
        const PlusCircle = ({ className }) => <Icon className={className} path={<><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></>} />;
        const X = ({ className }) => <Icon className={className} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />;
        const Save = ({ className }) => <Icon className={className} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />;
        const CheckCircle = ({ className }) => <Icon className={className} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
        const CheckCircle2 = ({ className }) => <Icon className={className} path={<><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>} />;
        const MessageSquare = ({ className }) => <Icon className={className} path={<><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></>} />;
        const Trash2 = ({ className }) => <Icon className={className} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />;
        const Pencil = ({ className }) => <Icon className={className} path={<><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></>} />;
        const Settings2 = ({ className }) => <Icon className={className} path={<><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></>} />;
        const Share2 = ({ className }) => <Icon className={className} path={<><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></>} />;
        const User = ({ className }) => <Icon className={className} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
        const Copy = ({ className }) => <Icon className={className} path={<><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>} />;
        const Check = ({ className }) => <Icon className={className} path={<><polyline points="20 6 9 17 4 12"/></>} />;
        const Edit3 = ({ className }) => <Icon className={className} path={<><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></>} />;
        const Globe = ({ className }) => <Icon className={className} path={<><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10z"/></>} />;
        const Star = ({ className }) => <Icon className={className} path={<><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></>} />;
        const ThumbsUp = ({ className }) => <Icon className={className} path={<><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></>} />;
        const MinusCircle = ({ className }) => <Icon className={className} path={<><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></>} />;
        const AlertCircle = ({ className }) => <Icon className={className} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />;

        const Brain = ({ className }) => <Icon className={className} path={<><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></>} />;
        const LinkIcon = ({ className }) => <Icon className={className} path={<><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></>} />;
        const Search = ({ className }) => <Icon className={className} path={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />;
        const Lightbulb = ({ className }) => <Icon className={className} path={<><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></>} />;
        const Target = ({ className }) => <Icon className={className} path={<><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></>} />;
        const Heart = ({ className }) => <Icon className={className} path={<><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></>} />;
        const Briefcase = ({ className }) => <Icon className={className} path={<><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></>} />;
        const Agile = ({ className }) => <Icon className={className} path={<><path d="M17.5 19C19.9853 19 22 16.9853 22 14.5C22 12.132 20.177 10.2 17.85 10.04C17.48 6.6 14.59 4 11 4C7.65 4 4.86 6.27 4.14 9.4C2.33 10 1 11.75 1 13.8C1 16.67 3.33 19 6.2 19H17.5Z" /><path d="M13.5 7.5C13.5 8.32843 12.8284 9 12 9C11.1716 9 10.5 8.32843 10.5 7.5C10.5 6.67157 11.1716 6 12 6C12.8284 6 13.5 6.67157 13.5 7.5Z" fill="currentColor" stroke="none"/><path d="M9 16L11.5 12L10 10.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M11.5 12L14.5 12L16 15.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M11.5 12L12.5 15.5L10.5 18" strokeLinecap="round" strokeLinejoin="round"/></>} />;

        // --- COMPONENTS ---

        const Header = () => {
            const DEFAULT_LOGO = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAbFBMVEX///8Amf8AlP8Alv8Alf8Alf8Alv8Alf8Alv8Alv8AmP8Alv8Alf8Alv8Alv8Alv8Alf8Alv8Alf8Alv8Alv8Alv8Alv8Alv8Alv8Alv8Alv8Alv8Alv8Alv8Alv8Alv8Alv8Alv8Alv98W13UAAAIGElEQVR4nO2da3uqOhCGRQXkIiJ4QcW2ttb+/5/4mAnJTYIkA4rtvT7vD61FA5NJJpNkxkwGg8FgMBgMBoPBYDAYDAaDwWAwGAwGg8FgMBgMBoPBYDAYDAaDwWAwGAwGg8FgMBgMBoPBYDAYDAaDwWAwGP5/6C8X/W0f4fs47/t+3w/8Yd/3/aHv+4Hze9uH+h6a9h+Xy+V6vV4ul8v1et1f2z7Y99Bf2z7M93G5Xq/76/V6uV6v++v1erleb/sI38nlcrnebvvr9Xq5Xm/76/VyuV6v1+v1er1cr1eb9fr5Xq9Xm/X6+V6vV6v1+v1er1erter1Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr9Xq9Xq/X6/V6vV6v1+v1er1er9fr";
            
            const [logo, setLogo] = useState(DEFAULT_LOGO);
            const fileInputRef = useRef(null);

            useEffect(() => {
                const stored = localStorage.getItem('teacher_report_logo');
                if (stored) setLogo(stored);
            }, []);

            const handleLogoClick = () => {
                fileInputRef.current?.click();
            };

            const handleFileChange = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const result = reader.result;
                        setLogo(result);
                        localStorage.setItem('teacher_report_logo', result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="bg-school-blue text-white pt-8 pb-16 px-6 shadow-md border-b-4 border-school-lightBlue">
                  <div className="max-w-5xl mx-auto flex items-start justify-between gap-4">
                    <div className="flex items-start gap-4">
                        <div className="relative group cursor-pointer" onClick={handleLogoClick} title="Click to change logo">
                            <div className="bg-white p-2 rounded-lg shadow-sm overflow-hidden">
                                <img 
                                    src={logo} 
                                    className="h-16 w-auto min-w-[64px] object-contain max-w-[200px]"
                                    alt="School Logo"
                                />
                            </div>
                            <div className="absolute inset-0 bg-black/50 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <span className="text-white text-xs font-bold px-2 py-1 bg-black/20 rounded">Change</span>
                            </div>
                            <input 
                                type="file" 
                                ref={fileInputRef} 
                                className="hidden" 
                                accept="image/*" 
                                onChange={handleFileChange} 
                            />
                        </div>
                        <div>
                            <h1 className="text-3xl font-bold tracking-tight text-white">Teacher Report Assistant</h1>
                            <p className="opacity-80 mt-2 max-w-2xl text-blue-100">Shared Online Edition</p>
                        </div>
                    </div>
                  </div>
                </div>
            );
        };

        const ClassSetup = ({ 
            subject, setSubject, subjectOptions, onStartClass, 
            onAddSubject, reportPeriod, setReportPeriod, 
            mockTitles, onUpdateMockTitle 
        }) => {
            const [namesInput, setNamesInput] = useState("");
            const [isCreatingSubject, setIsCreatingSubject] = useState(false);
            const [newSubjectName, setNewSubjectName] = useState("");
            const [newSubjectType, setNewSubjectType] = useState('full');

            const handleStart = () => {
                const students = namesInput.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                if (students.length === 0) {
                    alert("Please enter at least one student name.");
                    return;
                }
                onStartClass(students);
            };

            const handleSaveSubject = () => {
                if (newSubjectName.trim()) {
                    onAddSubject(newSubjectName.trim(), newSubjectType);
                    setIsCreatingSubject(false);
                    setNewSubjectName("");
                    setNewSubjectType('full');
                }
            };

            return (
                <div className="bg-white rounded-xl shadow-lg p-8 border-t-4 border-school-lightBlue animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Class Setup</h2>
                    <div className="grid grid-cols-1 gap-8">
                        <div className="space-y-2">
                            <label className="flex items-center gap-2 text-sm font-bold text-gray-700">
                                <Library className="w-4 h-4 text-school-lightBlue" /> 1. Select Subject
                            </label>
                            {isCreatingSubject ? (
                                <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 mt-1">
                                    <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Subject Name</label>
                                    <input type="text" autoFocus value={newSubjectName} onChange={(e) => setNewSubjectName(e.target.value)} placeholder="e.g. Year 8 Science" className="w-full p-3 border border-school-lightBlue rounded-lg outline-none mb-4 bg-white" />
                                    
                                    <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Report Structure</label>
                                    <div className="flex flex-col sm:flex-row gap-4 mb-6">
                                        <label className={`flex items-center gap-3 cursor-pointer p-3 rounded-lg border transition-all ${newSubjectType === 'full' ? 'bg-white border-school-lightBlue shadow-sm' : 'border-transparent hover:bg-white/50'}`}>
                                            <input type="radio" name="reportType" checked={newSubjectType === 'full'} onChange={() => setNewSubjectType('full')} className="w-4 h-4 text-school-lightBlue focus:ring-school-lightBlue" />
                                            <div className="flex flex-col">
                                                <span className="text-sm font-bold text-gray-800">Full Report</span>
                                                <span className="text-xs text-gray-500">5 Categories</span>
                                            </div>
                                        </label>
                                        <label className={`flex items-center gap-3 cursor-pointer p-3 rounded-lg border transition-all ${newSubjectType === 'shared' ? 'bg-white border-school-lightBlue shadow-sm' : 'border-transparent hover:bg-white/50'}`}>
                                            <input type="radio" name="reportType" checked={newSubjectType === 'shared'} onChange={() => setNewSubjectType('shared')} className="w-4 h-4 text-school-lightBlue focus:ring-school-lightBlue" />
                                            <div className="flex flex-col">
                                                <span className="text-sm font-bold text-gray-800">Shared Report</span>
                                                <span className="text-xs text-gray-500">Year 9 Style (3+ Optional)</span>
                                            </div>
                                        </label>
                                    </div>

                                    <div className="flex gap-2 justify-end">
                                        <button onClick={() => setIsCreatingSubject(false)} className="px-4 py-2 bg-white text-gray-600 border border-gray-300 rounded-lg font-medium text-sm hover:bg-gray-50">Cancel</button>
                                        <button onClick={handleSaveSubject} disabled={!newSubjectName.trim()} className="px-4 py-2 bg-school-lightBlue text-white rounded-lg font-bold text-sm shadow-sm hover:bg-school-blue disabled:opacity-50">Create Subject</button>
                                    </div>
                                </div>
                            ) : (
                                <div className="relative">
                                    <select value={subject} onChange={(e) => e.target.value === "__NEW__" ? (setIsCreatingSubject(true), setSubject("")) : setSubject(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg bg-white appearance-none cursor-pointer text-lg">
                                        <option value="">-- Select Subject --</option>
                                        {subjectOptions.map(subj => <option key={subj} value={subj}>{subj}</option>)}
                                        <option disabled>────────────────</option>
                                        <option value="__NEW__" className="font-bold text-school-lightBlue">+ Add New Subject...</option>
                                    </select>
                                </div>
                            )}
                        </div>
                        <div className={`space-y-2 transition-opacity duration-300 ${!subject ? 'opacity-50 pointer-events-none' : 'opacity-100'}`}>
                            <label className="flex items-center gap-2 text-sm font-bold text-gray-700">
                                <Calendar className="w-4 h-4 text-school-lightBlue" /> 2. Select Report Period
                            </label>
                            <div className="grid grid-cols-3 gap-4">
                                {["Progress 2", "Progress 3", "Mocks"].map(p => (
                                    <button key={p} onClick={() => setReportPeriod(p)} className={`p-4 rounded-lg border-2 font-bold ${reportPeriod === p ? (p === "Mocks" ? 'border-school-red bg-school-red text-white' : 'border-school-lightBlue bg-school-lightBlue text-white') : 'border-gray-200 bg-gray-50 text-gray-600'}`}>
                                        {p}
                                    </button>
                                ))}
                            </div>
                            {reportPeriod === "Mocks" && (
                                <div className="bg-red-50 border border-red-100 rounded-lg p-4 mt-2">
                                    <h3 className="text-school-red font-bold text-sm flex items-center gap-2 mb-2"><Edit3 className="w-4 h-4" /> Configure Mock Categories</h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        {[0, 1, 2, 3, 4].map((idx) => (
                                            <input key={idx} type="text" value={mockTitles?.[idx] || ""} onChange={(e) => onUpdateMockTitle && onUpdateMockTitle(idx, e.target.value)} placeholder={`Mock Category ${idx + 1}`} className="p-2 text-sm border border-red-200 rounded" />
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className={`space-y-2 transition-opacity duration-300 ${!subject ? 'opacity-50 pointer-events-none' : 'opacity-100'}`}>
                            <label className="flex items-center gap-2 text-sm font-bold text-gray-700">
                                <Users className="w-4 h-4 text-school-lightBlue" /> 3. Enter Student Names (One per line)
                            </label>
                            <textarea value={namesInput} onChange={(e) => setNamesInput(e.target.value)} placeholder="Alice Smith&#10;Bob Jones" className="w-full p-4 border border-gray-300 rounded-lg h-64 text-gray-700 leading-relaxed" />
                        </div>
                        <button onClick={handleStart} disabled={!subject || !namesInput.trim()} className="w-full bg-school-red text-white font-bold py-4 rounded-lg shadow-md hover:bg-school-redHover disabled:opacity-50 transition-all flex items-center justify-center gap-2 text-lg">
                            Start Report Cycle <ArrowRight className="w-5 h-5" />
                        </button>
                    </div>
                </div>
            );
        };

        const CommentCategory = ({ 
            category, optionsMap, customOptionsMap, currentValue, onChange, 
            onAddComment, onDeleteCustomComment, onEditCustomComment, compact = false,
            levels
        }) => {
            const [activeLevel, setActiveLevel] = useState(null);
            const [isAdding, setIsAdding] = useState(false);
            const [newComment, setNewComment] = useState("");
            const [isManaging, setIsManaging] = useState(false);
            const [editingComment, setEditingComment] = useState(null);
            const [editedText, setEditedText] = useState("");

            useEffect(() => {
                setActiveLevel(null);
                setIsAdding(false);
                setIsManaging(false);
                setNewComment("");
                setEditingComment(null);
                setEditedText("");
            }, [category.id]);

            const handleSaveNewComment = () => {
                if (newComment.trim() && activeLevel) {
                    onAddComment(newComment.trim(), activeLevel);
                    onChange(newComment.trim());
                    setNewComment("");
                    setIsAdding(false);
                }
            };

            const getLevelIcon = (level) => {
                switch (level) {
                    case "Excellent": return Star;
                    case "Good": return ThumbsUp;
                    case "Average": return MinusCircle;
                    case "Poor": return AlertCircle;
                    case "Collaboration/Empathy": return Heart;
                    case "Agile": return Agile;
                    case "Hard Working": return Briefcase;
                    case "Meta-Thinking": return Brain;
                    case "Linking": return LinkIcon;
                    case "Analysing": return Search;
                    case "Creating": return Lightbulb;
                    case "Realising": return Target;
                    case "Empathetic": return Heart;
                    default: return null;
                }
            };

            const activeOptions = (activeLevel && optionsMap && optionsMap[activeLevel]) || [];
            const customOptions = (activeLevel && customOptionsMap && customOptionsMap[activeLevel]) || [];

            return (
                <div className={`${compact ? 'p-4' : 'bg-white rounded-xl shadow-sm p-6 border-l-4 border-school-lightBlue'} transition-shadow relative`}>
                    {!compact && (
                        <div className="flex items-center gap-2 mb-4">
                            <MessageSquare className="w-5 h-5 text-school-lightBlue opacity-75" />
                            <h3 className="text-lg font-bold text-gray-800">{category.label}</h3>
                        </div>
                    )}
                    <div className="mb-4">
                        <div className="flex flex-wrap gap-2">
                            {levels && levels.map((lvl) => {
                                const Icon = getLevelIcon(lvl);
                                return (
                                    <button key={lvl} onClick={() => { setActiveLevel(lvl); setIsAdding(false); setIsManaging(false); }} className={`px-3 py-1.5 rounded-lg text-xs font-medium border flex items-center gap-1.5 transition-all ${activeLevel === lvl ? 'bg-school-lightBlue text-white border-school-lightBlue shadow-md' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}>
                                        {Icon && <Icon className={`w-3.5 h-3.5 ${activeLevel === lvl ? 'text-blue-200' : 'text-gray-400'}`} />}
                                        {lvl}
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                    <div className={`space-y-3 transition-all duration-300 ${activeLevel ? 'opacity-100' : 'opacity-50 grayscale'}`}>
                        <div>
                            <div className="flex justify-between items-end mb-1">
                                <label className="text-xs text-gray-500 font-medium ml-1">{activeLevel ? `${activeLevel} Comments` : "Select a category..."}</label>
                                {activeLevel && (
                                    <div className="flex gap-2">
                                        <button onClick={() => setIsManaging(!isManaging)} className="flex items-center gap-1 text-xs font-semibold text-gray-500 hover:bg-gray-100 px-2 py-1 rounded"><Settings2 className="w-3 h-3" /></button>
                                        {!isAdding && <button onClick={() => { setIsAdding(true); setIsManaging(false); }} className="flex items-center gap-1 text-xs font-semibold text-school-lightBlue hover:bg-blue-50 px-2 py-1 rounded"><PlusCircle className="w-3 h-3" /> Add New</button>}
                                    </div>
                                )}
                            </div>
                            {isManaging && activeLevel && (
                                <div className="mb-3 p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm">
                                    <div className="flex justify-between items-center mb-2 pb-2 border-b border-gray-200"><span className="font-bold text-gray-700">Manage Custom Comments</span><button onClick={() => setIsManaging(false)}><X className="w-3 h-3 text-gray-400" /></button></div>
                                    <div className="space-y-2 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                                        {customOptions.map((opt, idx) => (
                                            <div key={idx} className="bg-white p-2 rounded border border-gray-100 flex items-start gap-2 group">
                                                {editingComment === opt ? (
                                                    <div className="flex-1 flex gap-2">
                                                        <input type="text" value={editedText} onChange={(e) => setEditedText(e.target.value)} className="flex-1 border p-1 rounded text-xs" />
                                                        <button onClick={() => { if (onEditCustomComment && editedText.trim()) { onEditCustomComment(opt, editedText, activeLevel); setEditingComment(null); } }}><Save className="w-3 h-3 text-green-600" /></button>
                                                        <button onClick={() => setEditingComment(null)}><X className="w-3 h-3 text-red-500" /></button>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <p className="flex-1 text-xs text-gray-700 leading-tight">{opt}</p>
                                                        <div className="flex gap-1 opacity-0 group-hover:opacity-100">
                                                            <button onClick={() => { setEditingComment(opt); setEditedText(opt); }}><Pencil className="w-3 h-3 text-blue-500" /></button>
                                                            <button onClick={() => { if (onDeleteCustomComment && confirm("Delete?")) onDeleteCustomComment(opt, activeLevel); }}><Trash2 className="w-3 h-3 text-red-500" /></button>
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            {isAdding && activeLevel ? (
                                <div className="mb-2 p-3 bg-blue-50 border border-blue-100 rounded-lg">
                                    <input type="text" value={newComment} onChange={(e) => setNewComment(e.target.value)} placeholder="Type comment here..." className="w-full p-2 border border-blue-200 rounded mb-2 text-sm" autoFocus />
                                    <div className="flex justify-end gap-2"><button onClick={() => setIsAdding(false)} className="text-xs px-2 py-1 bg-white border rounded">Cancel</button><button onClick={handleSaveNewComment} disabled={!newComment.trim()} className="text-xs px-2 py-1 bg-school-lightBlue text-white rounded">Save</button></div>
                                </div>
                            ) : (
                                <div className="relative">
                                    <select className="w-full p-2 pl-3 border border-gray-300 rounded-md bg-gray-50 text-sm appearance-none cursor-pointer" onChange={(e) => onChange(e.target.value)} value="" disabled={!activeLevel}>
                                        <option value="" disabled>{activeLevel ? "Select a comment..." : "Select level first..."}</option>
                                        {activeOptions.map((opt, idx) => <option key={idx} value={opt}>{opt}</option>)}
                                    </select>
                                    <div className="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none text-gray-500">
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                                    </div>
                                </div>
                            )}
                        </div>
                        <textarea rows={2} value={currentValue} onChange={(e) => onChange(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg outline-none text-sm leading-relaxed" placeholder="Selected comment appears here..."></textarea>
                    </div>
                </div>
            );
        };

        const BatchStep = ({ 
            category, students, classData, optionsMap, customOptionsMap, 
            reportPeriod, onUpdateStudent, onAddCustomComment, 
            onDeleteCustomComment, onEditCustomComment, onShareWithP3, 
            onShareAcrossAllSubjects, levels
        }) => {
            const isHPLOrLanguage = category.id === 'HPL' || category.id === 'Language';
            
            return (
                <div className="space-y-8 animate-in fade-in slide-in-from-right-8 duration-500">
                    <div className="bg-blue-50 border-l-4 border-school-lightBlue p-4 rounded-r-lg mb-6 flex justify-between items-center flex-wrap gap-4">
                        <div>
                            <h2 className="text-xl font-bold text-school-blue">Category: {category.label}</h2>
                        </div>
                        <div className="flex gap-2">
                            {reportPeriod === "Progress 2" && !isHPLOrLanguage && (
                                <button onClick={onShareWithP3} className="flex items-center gap-2 px-3 py-2 bg-white border border-school-lightBlue text-school-lightBlue rounded-lg text-xs font-bold shadow-sm">
                                    <Share2 className="w-4 h-4" /> Share with P3 (This Subject Only)
                                </button>
                            )}
                            {isHPLOrLanguage && (
                                <button onClick={onShareAcrossAllSubjects} className="flex items-center gap-2 px-3 py-2 bg-purple-600 text-white border border-purple-700 rounded-lg text-xs font-bold shadow-sm">
                                    <Globe className="w-4 h-4" /> Update for All Subjects
                                </button>
                            )}
                        </div>
                    </div>
                    <div className="grid grid-cols-1 gap-6">
                        {students.map((student, index) => (
                            <div key={student} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="bg-gray-50 px-6 py-3 border-b border-gray-100 flex items-center gap-2">
                                    <span className="bg-school-lightBlue text-white text-xs font-bold px-2 py-1 rounded-full">{index + 1}</span>
                                    <h3 className="font-bold text-gray-800 flex items-center gap-2"><User className="w-4 h-4 text-gray-400" /> {student}</h3>
                                </div>
                                <div className="p-2">
                                    <CommentCategory 
                                        category={category} 
                                        optionsMap={optionsMap} 
                                        customOptionsMap={customOptionsMap} 
                                        currentValue={classData[student]?.[category.id] || ""} 
                                        onChange={(val) => onUpdateStudent(student, category.id, val)} 
                                        onAddComment={onAddCustomComment} 
                                        onDeleteCustomComment={onDeleteCustomComment} 
                                        onEditCustomComment={onEditCustomComment} 
                                        compact={true} 
                                        levels={levels}
                                    />
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ResultPanel = ({ prompt }) => {
            const [copied, setCopied] = useState(false);
            
            const handleCopy = () => {
                navigator.clipboard.writeText(prompt);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            return (
                <div className="mt-8 bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200">
                    <div className="p-4 border-b flex justify-between items-center bg-gray-50 border-gray-200">
                        <h3 className="font-bold text-gray-700">Generated Class Report Document</h3>
                        <div className="flex gap-2">
                            <button onClick={handleCopy} className="flex items-center gap-1.5 px-4 py-2 bg-school-lightBlue text-white rounded-lg hover:bg-school-blue font-bold shadow-sm transition-colors">
                                {copied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                                {copied ? "Copied!" : "Copy All"}
                            </button>
                        </div>
                    </div>
                    <div className="p-0">
                        <textarea readOnly value={prompt} className="w-full min-h-[500px] p-6 bg-gray-50 resize-y focus:outline-none font-mono text-sm text-gray-800 leading-relaxed border-none" spellCheck={false} />
                    </div>
                </div>
            );
        };

        const ActionPanel = ({ onBack, onNext, isLastStep, canProceed }) => (
            <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg z-50">
                <div className="max-w-5xl mx-auto flex justify-between gap-4">
                    <button onClick={onBack} className="flex items-center gap-2 px-6 py-3 rounded-lg font-bold text-gray-600 hover:bg-gray-100 transition-colors">
                        <ArrowLeft className="w-5 h-5" /> Back
                    </button>
                    <button 
                        onClick={onNext} 
                        disabled={!canProceed} 
                        className={`flex items-center gap-2 px-8 py-3 rounded-lg font-bold text-white transition-all shadow-md ${canProceed ? (isLastStep ? 'bg-green-600 hover:bg-green-700' : 'bg-school-lightBlue hover:bg-school-blue') : 'bg-gray-300 cursor-not-allowed'}`}
                    >
                        {isLastStep ? <><CheckCircle className="w-5 h-5" /> Finish & Generate</> : <><ArrowRight className="w-5 h-5" /> Next Category</>}
                    </button>
                </div>
            </div>
        );

        const App = () => {
            const [subject, setSubject] = useState("");
            const [students, setStudents] = useState([]);
            const [currentStepIndex, setCurrentStepIndex] = useState(0);
            const [customSubjects, setCustomSubjects] = useState([]);
            const [reportPeriod, setReportPeriod] = useState("Progress 2");
            const [classData, setClassData] = useState({});
            const [customBank, setCustomBank] = useState({});
            const [finalBatchPrompt, setFinalBatchPrompt] = useState("");
            const [mockTitles, setMockTitles] = useState({});
            const [subjectTypes, setSubjectTypes] = useState({});
            const [loading, setLoading] = useState(true);

            // --- FIREBASE SYNC EFFECT ---
            useEffect(() => {
                const sharedRef = db.collection('teacher_reports').doc(SHARED_DOC_ID);
                
                const unsubscribe = sharedRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.customSubjects) setCustomSubjects(data.customSubjects);
                        if (data.subjectTypes) setSubjectTypes(data.subjectTypes);
                        if (data.mockTitles) setMockTitles(data.mockTitles);
                        if (data.customBank) setCustomBank(data.customBank);
                    } else {
                        // Create doc if it doesn't exist
                        sharedRef.set({
                            customSubjects: [],
                            subjectTypes: {},
                            mockTitles: {},
                            customBank: {}
                        });
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            const saveToFirebase = (key, value) => {
                db.collection('teacher_reports').doc(SHARED_DOC_ID).update({
                    [key]: value
                }).catch(err => console.error("Error saving to shared DB:", err));
            };

            const handleAddSubject = (newSubject, type) => {
                if (!newSubject.trim()) return;

                const updatedTypes = { ...subjectTypes, [newSubject]: type };
                // Optimistic UI update
                setSubjectTypes(updatedTypes);
                
                // Initialize default shared comments structure if needed
                let newBank = { ...customBank };
                if (!Object.keys(COMMENT_BANK).includes(newSubject) && !customSubjects.includes(newSubject)) {
                    // (Logic from original app to prepopulate shared bank)
                    const existingSharedHPL = Object.keys(newBank).find(k => k.endsWith('::SHARED') && newBank[k]?.['HPL']);
                    if (existingSharedHPL) {
                        const sourceData = newBank[existingSharedHPL]['HPL'];
                        const newKey = `${newSubject}::SHARED`;
                        newBank[newKey] = { ...(newBank[newKey] || {}), 'HPL': sourceData };
                    }
                    
                    const newSharedKey = `${newSubject}::SHARED`;
                    const existingSharedLang = Object.keys(newBank).find(k => k.endsWith('::SHARED') && newBank[k]?.['Language']);
                    let newLangData = { "Excellent": [], "Good": [], "Average": [], "Poor": [] };
                    if (existingSharedLang) {
                        const sourceLang = newBank[existingSharedLang]['Language'];
                        ["Excellent", "Good", "Average", "Poor"].forEach(level => {
                             newLangData[level] = sourceLang[level] || [];
                        });
                    }
                    newBank[newSharedKey] = { ...(newBank[newSharedKey] || {}), 'Language': newLangData };
                }

                const updatedSubjects = [...customSubjects, newSubject];
                setCustomSubjects(updatedSubjects);
                
                // Save all changes to Firebase
                db.collection('teacher_reports').doc(SHARED_DOC_ID).update({
                    subjectTypes: updatedTypes,
                    customSubjects: updatedSubjects,
                    customBank: newBank
                });

                setSubject(newSubject);
            };

            const handleUpdateMockTitle = (idx, val) => {
                setMockTitles(prev => {
                    const current = prev[subject] || ["", "", "", "", ""];
                    const next = [...current];
                    next[idx] = val;
                    const updated = { ...prev, [subject]: next };
                    saveToFirebase('mockTitles', updated);
                    return updated;
                });
            };

            const getCategories = () => {
                if (reportPeriod === "Mocks") {
                    const titles = mockTitles[subject] || ["", "", "", "", ""];
                    return titles.map((t, i) => ({ id: `Mock${i + 1}`, label: t.trim() })).filter(c => c.label.length > 0);
                }

                const isShared = subjectTypes[subject] === 'shared';
                const isYear9 = !subjectTypes[subject] && subject.startsWith("Year 9");

                if (isShared || isYear9) {
                    return [
                        { id: "Assessment", label: "Assessment" },
                        { id: "Improvement", label: "Improvement" },
                        { id: "HPL", label: "HPL (Approaches to Learning) (Optional)", optional: true },
                        { id: "Language", label: "Language (Optional)", optional: true },
                        { id: "Homework", label: "Homework (Optional)", optional: true }
                    ];
                }
                return [
                    { id: "HPL", label: "HPL (Approaches to Learning)" },
                    { id: "Language", label: "Language" },
                    { id: "Assessment", label: "Assessment" },
                    { id: "Homework", label: "Homework" },
                    { id: "Improvement", label: "Improvement" }
                ];
            };

            const categories = subject ? getCategories() : [];
            const isSetup = students.length === 0;
            const isResultStep = !isSetup && currentStepIndex === categories.length;
            const activeCategory = (!isSetup && !isResultStep) ? categories[currentStepIndex] : null;

            const handleStartClass = (names) => {
                if (reportPeriod === "Mocks" && categories.length === 0) {
                    alert("Please configure mock categories.");
                    return;
                }
                setStudents(names);
                setCurrentStepIndex(0);
                const initClassData = {};
                names.forEach(name => { initClassData[name] = {}; });
                setClassData(initClassData);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const getBankKey = (catId) => (catId === 'HPL' || catId === 'Language') ? `${subject}::SHARED` : `${subject}::${reportPeriod}`;

            const handleUpdateStudent = (name, catId, val) => {
                setClassData(prev => ({ ...prev, [name]: { ...prev[name], [catId]: val } }));
            };

            const updateCustomBank = (updater) => {
                setCustomBank(prev => {
                    const next = updater(prev);
                    saveToFirebase('customBank', next);
                    return next;
                });
            };

            const handleAddCustomComment = (catId, text, level) => {
                updateCustomBank(prev => {
                    const key = getBankKey(catId);
                    const subjBank = prev[key] || {};
                    const catBank = subjBank[catId] || {};
                    const lvlArr = catBank[level] || [];
                    if (lvlArr.includes(text)) return prev;
                    return { ...prev, [key]: { ...subjBank, [catId]: { ...catBank, [level]: [...lvlArr, text] } } };
                });
            };

            const handleDeleteCustomComment = (text, level) => {
                if (!activeCategory) return;
                updateCustomBank(prev => {
                    const catId = activeCategory.id;
                    const key = getBankKey(catId);
                    const subjBank = prev[key] || {};
                    const catBank = subjBank[catId] || {};
                    const lvlArr = catBank[level] || [];
                    return { ...prev, [key]: { ...subjBank, [catId]: { ...catBank, [level]: lvlArr.filter(c => c !== text) } } };
                });
            };

            const handleEditCustomComment = (oldText, newText, level) => {
                if (!activeCategory) return;
                updateCustomBank(prev => {
                    const catId = activeCategory.id;
                    const key = getBankKey(catId);
                    const subjBank = prev[key] || {};
                    const catBank = subjBank[catId] || {};
                    const lvlArr = catBank[level] || [];
                    return { ...prev, [key]: { ...subjBank, [catId]: { ...catBank, [level]: lvlArr.map(c => c === oldText ? newText : c) } } };
                });
            };

            const handleShareWithP3 = () => {
                if (reportPeriod !== "Progress 2" || !activeCategory) return;
                updateCustomBank(prev => {
                    const catId = activeCategory.id;
                    const srcKey = getBankKey(catId);
                    const targetKey = `${subject}::Progress 3`;
                    const data = prev[srcKey]?.[catId];
                    if (!data) {
                        alert("No comments to share.");
                        return prev;
                    }
                    const existingTarget = prev[targetKey] || {};
                    return { ...prev, [targetKey]: { ...existingTarget, [catId]: data } };
                });
                alert("Shared to P3.");
            };

            const getLevels = (catId) => catId === 'HPL' ? HPL_LEVELS : STANDARD_LEVELS;

            const handleShareAcrossAllSubjects = () => {
                if (!activeCategory) return;
                updateCustomBank(prev => {
                    const catId = activeCategory.id;
                    const srcKey = `${subject}::SHARED`;
                    const data = prev[srcKey]?.[catId];
                    if (!data) {
                        alert("No comments to share.");
                        return prev;
                    }
                    const next = { ...prev };
                    const currentLevels = getLevels(catId);
                    [...Object.keys(COMMENT_BANK), ...customSubjects].forEach(tSubj => {
                        if (tSubj === subject) return;
                        const tKey = `${tSubj}::SHARED`;
                        const existingSubj = next[tKey] || {};
                        const existingCat = existingSubj[catId] || {};
                        const merged = { ...existingCat };
                        currentLevels.forEach(l => {
                            merged[l] = Array.from(new Set([...(existingCat[l] || []), ...(data[l] || [])]));
                        });
                        next[tKey] = { ...existingSubj, [catId]: merged };
                    });
                    return next;
                });
                alert("Shared across subjects.");
            };

            const getOptionsMap = (catId, customOnly = false) => {
                const map = {};
                const levels = getLevels(catId);
                levels.forEach(l => map[l] = []);
                
                if (!subject) return map;
                const key = getBankKey(catId);
                
                levels.forEach(l => {
                    const staticOpts = (!customOnly && reportPeriod !== "Mocks") ? (COMMENT_BANK[subject]?.[catId]?.[l] || []) : [];
                    const customOpts = customBank[key]?.[catId]?.[l] || [];
                    let legacy = [];
                    if (reportPeriod === "Progress 2") {
                        legacy = customBank[subject]?.[catId]?.[l] || [];
                    }
                    map[l] = Array.from(new Set([...staticOpts, ...customOpts, ...legacy]));
                });
                return map;
            };

            const generateFinalBatch = () => {
                let out = "";
                students.forEach(s => {
                    out += `${s}\n`;
                    categories.forEach(c => {
                        const txt = classData[s]?.[c.id];
                        if (txt) out += `• ${txt.replace(/\n/g, ' ').trim()}\n`;
                    });
                    out += `\n-----------------------------------\n\n`;
                });
                setFinalBatchPrompt(out);
            };

            const handleNext = () => {
                if (currentStepIndex === categories.length - 1) {
                    generateFinalBatch();
                    setCurrentStepIndex(currentStepIndex + 1);
                } else {
                    setCurrentStepIndex(currentStepIndex + 1);
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleBack = () => {
                if (currentStepIndex === 0) {
                    if (confirm("Reset class?")) {
                        setStudents([]);
                        setSubject("");
                    }
                } else {
                    setCurrentStepIndex(currentStepIndex - 1);
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-school-lightBlue mx-auto mb-4"></div>
                            <p className="text-gray-600 font-medium">Connecting to Shared Database...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 pb-32">
                    <Header />
                    <main className="max-w-5xl mx-auto px-4 sm:px-6 -mt-8 relative z-10">
                        {!isSetup && !isResultStep && (
                            <div className="mb-6 bg-white rounded-lg shadow-sm p-4 flex items-center justify-between sticky top-4 z-40 border border-gray-200">
                                <div className="flex items-center gap-2">
                                    <Users className="w-5 h-5 text-school-lightBlue" />
                                    <span className="font-bold text-gray-700">{students.length} Students</span>
                                    <span className="text-gray-400">|</span>
                                    <span className="text-sm font-medium text-gray-500">{subject}</span>
                                    <span className="text-gray-400">|</span>
                                    <span className="text-sm font-medium text-school-red">{reportPeriod}</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-sm font-medium text-gray-500">Step {currentStepIndex + 1} of {categories.length}</span>
                                    <div className="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div className="h-full bg-school-lightBlue transition-all duration-500" style={{ width: `${((currentStepIndex + 1) / categories.length) * 100}%` }}></div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isSetup && (
                            <ClassSetup
                                subject={subject}
                                setSubject={setSubject}
                                subjectOptions={[...Object.keys(COMMENT_BANK), ...customSubjects].sort()}
                                onStartClass={handleStartClass}
                                onAddSubject={handleAddSubject}
                                reportPeriod={reportPeriod}
                                setReportPeriod={setReportPeriod}
                                mockTitles={mockTitles[subject] || ["", "", "", "", ""]}
                                onUpdateMockTitle={handleUpdateMockTitle}
                            />
                        )}

                        {activeCategory && (
                            <BatchStep
                                category={activeCategory}
                                students={students}
                                classData={classData}
                                optionsMap={getOptionsMap(activeCategory.id)}
                                customOptionsMap={getOptionsMap(activeCategory.id, true)}
                                reportPeriod={reportPeriod}
                                onUpdateStudent={handleUpdateStudent}
                                onAddCustomComment={(t, l) => handleAddCustomComment(activeCategory.id, t, l)}
                                onDeleteCustomComment={handleDeleteCustomComment}
                                onEditCustomComment={handleEditCustomComment}
                                onShareWithP3={handleShareWithP3}
                                onShareAcrossAllSubjects={handleShareAcrossAllSubjects}
                                levels={getLevels(activeCategory.id)}
                            />
                        )}

                        {isResultStep && (
                            <div className="animate-in fade-in zoom-in-95 duration-500">
                                <div className="bg-green-50 border border-green-200 rounded-lg p-6 mb-6 text-center">
                                    <div className="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                                        <CheckCircle2 className="w-8 h-8 text-green-600" />
                                    </div>
                                    <h2 className="text-2xl font-bold text-green-800">Class Reports Generated!</h2>
                                </div>
                                <ResultPanel prompt={finalBatchPrompt} />
                                <div className="mt-8 text-center">
                                    <button onClick={() => window.location.reload()} className="text-gray-500 hover:text-gray-700 underline">Start Over</button>
                                </div>
                            </div>
                        )}
                    </main>
                    {!isSetup && !isResultStep && (
                        <ActionPanel
                            onBack={handleBack}
                            onNext={handleNext}
                            isLastStep={currentStepIndex === categories.length - 1}
                            canProceed={true}
                        />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
